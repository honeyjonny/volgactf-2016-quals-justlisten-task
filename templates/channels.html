{% extends "base.html" %}


{% block body %}

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js" type="text/javascript"></script>
	<script type="text/javascript">
    
   console.log(1);
   var initModal = function(context){
				

                var butt = $(context),
                    modal = $('#myModal'),
                    modalDialog = modal.find('.modal-dialog'),
                    modalCloseBtn = modal.find('button.close'),
                    modalSendMessBtn = modal.find('button.btn-primary'),
                    modalTextArea = modal.find('.modal-footer textarea'),
                    modalBody = modal.find('.modal-body');
                
                modal.addClass('in');
                
                console.log(modalCloseBtn);

                var url = "ws://" + location.host + butt.attr('link'),
                    socket = new WebSocket(url);

                    socket.onopen = function(){
                    	console.log("open channel");
                    	socket.send("hello");
                    };
                    
                    socket.onmessage = function(evt){
                    	console.log(evt.data);
                    	var messText = $('<div/>');

                    	messText.text(evt.data);
                    	messText.prependTo(modalBody);
                    };
                 
                 //close modal
                 modalCloseBtn.on('click', function(){
                    
                    modalSendMessBtn.off('click'); 
                    modalCloseBtn.off('click');
                    modalTextArea.val(''); 
                    
                    modal.removeClass('in');
                     
                 });
                 
                 modalSendMessBtn.on('click', function(){

if(modalTextArea.val() != ''){

                 	socket.send(modalTextArea.val());
                 	modalTextArea.val('');
    				
                    }
                    
                     
                 });


   };
        //говнокод, зато быстрый    
		// $(document).ready(function(){
		// 	console.log($("#but"));
		// 	setTimeout(function(){

		// 	});
		// 	$("#but").on("click", function(){
				
                 
                 
                 
  //               //$("#myModal").modal("toggle")
		// 	})
		// });
        
        

	</script>

	<div style="margin-top: 30px">
		<h3><span class="label label-primary">Ready for use channels:</span> </h3>	
	</div>

	<div class="list-group" style="margin-top: 60px">
		{% for channel in channels %}
			<div class="row list-group-item">
				<p class="text-left col-md-8">{{ channel["name"] }}</p>
				<input type="hidden" name="channel_id" value="/channels/{{ channel["_id"] }}">
				<button id="but" type="button" link="/channels/{{ channel["_id"] }}" class="btn btn-primary btn-xs col-md-2" onclick="initModal(this)" style="float: right;">Connect</button> 
			</div>
		{% end %}
	</div>



	<div id="myModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
		<div class="modal-dialog" role="document">
		      <div class="modal-header">
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		        <h4 class="modal-title" id="myModalLabel"></h4>
      		</div>
			<div class="modal-body">
				<h3><span class="label label-primary">Modal Label</span> </h3>	
			</div>
			<div class="modal-footer">
				<form>
					<textarea 
						type="text"
						placeholder="write message here"></textarea>
        			<button type="button" class="btn btn-primary">Send</button>
        		</form>
      		</div>
		</div>
	</div>

	<style>
		#myModal{
			width: 100%;
			height:  100%;
			    position: absolute;
			    top: 0;
			    left: 0;
			    background-color: rgba(0,0,0,0.2);
		}
		#myModal.in{
			display: block;
		}
		#myModal .modal-footer textarea{
			    float: left;
    width: calc(100% - 70px);
    border-radius: 4px;
    border-color: #ddd;
		}
		#myModal .modal-dialog{
			background-color: #fff;
    		border-radius: 10px;
    		    height: calc(100% - 65px);
		} 
		#myModal .modal-body{
height: calc(100% - 129px);	
    display: flex;
    flex-direction: column-reverse;	
        overflow-y: auto;	
		}

	</style>


	
{% end %}